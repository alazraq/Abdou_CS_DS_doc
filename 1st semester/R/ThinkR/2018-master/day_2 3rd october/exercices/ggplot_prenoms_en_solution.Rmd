---
title: "Exercises with ggplot2 and dplyr"
subtitle: ' '
output:
  html_document: default
  pdf_document: default
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
  echo = FALSE
)
```

# Init
## Create an new R project.

## load here the packages {tidyverse} and {prenoms} you need. You will add other required package in this chunk later.

_ the {prenoms} package isn't on CRAN, if missing you can install it with : `devtools::install_github( "ThinkR-open/prenoms" )`

```{r}
library(tidyverse)
library(prenoms)
```

## Re-create the following figures

### Evolution of popularity of men named "Colin" at birth

- Dataset : prenoms
- *Be carefull, some years show the absence of this name*

```{r}
prenoms %>%
  filter(name == "Colin", sex == "M") %>%
  group_by(year) %>%
  summarise(n = sum(n, na.rm = TRUE)) %>%
  complete(year = 1900:2017) %>%
  mutate(n = if_else(is.na(n), as.integer(0), n)) %>%
  ggplot(aes(year,n)) + 
  geom_line() +
  labs(title = "Evolution of popularity of men named Colin at birth") + 
  theme_minimal()
```



### Evolution of popularity of four names

- Dataset : prenoms
- "Colin", "Diane", "Sébastien", "Vincent"

```{r }
prenoms %>% 
  group_by(year, name) %>% 
  summarise(total = sum(n)) %>% 
  filter(name %in% c("Colin", "Diane", "Sébastien", "Vincent")) %>%
  ggplot(aes(year,total, color = name))+
  geom_line() +
  labs(title = "Evolution of popularity of four names") + 
  theme_minimal()
```

### Total number of birth by year

- Dataset : prenoms

```{r }
prenoms %>% 
  group_by(year) %>% 
  summarise(total = sum(n)) %>% 
  ggplot(aes(year,total))+
  geom_col() +
  labs(title = "Total number of birth by year") + 
  theme_minimal()
```

### Total number of birth by year and by sex

- Dataset : prenoms

```{r }
prenoms %>% 
  group_by(year, sex) %>% 
  summarise(total = sum(n)) %>% 
  ggplot(aes(year,total, fill = sex))+
  geom_col(width = 1) +
  scale_fill_viridis_d() +
  facet_grid(sex ~ .) +
  labs(title = "Total number of birth by year and by sex") + 
  theme_minimal()
```


### Total number of birth by year and by sex in proportion

- Dataset : prenoms

```{r }
prenoms %>% 
  group_by(year, sex) %>% 
  summarise(total = sum(n)) %>% 
  ggplot(aes(year,total, fill = sex)) +
  geom_col(position = "fill", width = 1) +
  geom_hline(yintercept = 0.5, colour = "red") +
  scale_fill_viridis_d() +
  labs(title = "Total number of birth by year and by sex in proportion") + 
  theme_minimal()
```

### Distribution of yearly birth for department 44

- Dataset : prenoms
- You need to calculate a total number of birth by year for this department

```{r, fig.height=5, fig.width=9, out.width="100%"}
prenoms %>% 
  filter(dpt == 44) %>% 
  group_by(year) %>% 
  summarise(total = sum(n)) %>% 
  ggplot(aes(total)) + 
  geom_density(fill = "grey80") +
  labs(title = "Distribution of yearly birth for department 44") + 
  theme_minimal()
```

### Compare distributions of yearly birth for departments 10 to 30

- Dataset : prenoms
- You need to calculate a total number of birth by year for each department
- Try to fill the plot according to the median value in each department

```{r, fig.width=8, fig.height=6}
dpt_year <- prenoms %>% 
  filter(dpt %in% (10:30)) %>% 
  group_by(dpt, year) %>% 
  summarise(total = sum(n)) %>% 
  ungroup()

mean_dpt_year <- dpt_year %>% 
  group_by(dpt) %>% 
  summarise(median = median(total))
  
dpt_year %>% 
  left_join(mean_dpt_year, by = "dpt") %>% 
  ggplot(aes(dpt, total, fill = median)) +
  geom_violin(draw_quantiles = 0.5, color = "grey") +
  scale_fill_viridis_c() +
  labs(title = "Distributions of yearly birth for departments 10 to 30") + 
  theme_minimal()
```

### Compare births in departments 10 to 30 by year with a heatmap

- Dataset : prenoms
- You can use median value for each department to reorder 

```{r}
dpt_year <- prenoms %>% 
  filter(dpt %in% (10:30)) %>% 
  group_by(dpt, year) %>% 
  summarise(total = sum(n)) %>% 
  ungroup()

mean_dpt_year <- dpt_year %>% 
  summarise(median = median(total))

dpt_year %>% 
  # mutate(dpt = factor(dpt, levels = mean_dpt_year$dpt[order(mean_dpt_year$median)])) %>%
  # mutate(dpt = forcats::fct_reorder(dpt, total, .fun = median)) %>% 
  # ggplot(aes(year, dpt, fill = total)) +
  ggplot(aes(year, reorder(dpt, total, FUN = median), fill = total)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(title = "Compare births in departments by year with a heatmap",
       y = "Department (ordered)", x = "Year") + 
  theme_minimal()

```

